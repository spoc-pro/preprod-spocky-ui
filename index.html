<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Spocky ‚Äì Assistant support SPOC</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- ‚úÖ Cloudflare Turnstile -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #1D1D1B;
  color: white;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

/* ===== AUTH ===== */
#auth-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.9);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

#auth-box {
  background: #2a2a28;
  padding: 32px;
  border-radius: 16px;
  width: 360px;
  text-align: center;
  animation: fadeInUp 0.6s ease-out;
}

.auth-logo {
  width: 90px;
  margin-bottom: 16px;
}

#auth-box input {
  width: 100%;
  padding: 12px;
  margin-top: 12px;
  border-radius: 8px;
  border: none;
  font-size: 15px;
}

#auth-box button {
  width: 100%;
  margin-top: 20px;
  padding: 12px;
  background: #23817A;
  border: none;
  border-radius: 8px;
  color: white;
  font-size: 15px;
  cursor: pointer;
}

/* ===== HEADER ===== */
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px 20px;
  border-bottom: 1px solid #333;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.header-left img {
  width: 42px;
}

.badge-user {
  font-size: 13px;
  color: #ccc;
}

.logout {
  margin-left: 12px;
  cursor: pointer;
  color: #ff6b6b;
  font-size: 13px;
}

/* ===== CHAT ===== */
#chat {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

.message {
  max-width: 70%;
  padding: 12px 14px;
  border-radius: 14px;
  margin-bottom: 12px;
  line-height: 1.4;
}

.bot {
  background: white;
  color: black;
}

.user {
  background: #23817A;
  color: white;
  align-self: flex-end;
}

/* ===== BUTTONS ===== */
.choice-btn {
  margin-top: 10px;
  padding: 10px 14px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-size: 14px;
}

.ticket { background: #23817A; color: white; }
.ai { background: #444; color: white; }

/* ===== INPUT ===== */
footer {
  padding: 14px;
  border-top: 1px solid #333;
  display: flex;
  gap: 10px;
}

footer input {
  flex: 1;
  padding: 12px;
  border-radius: 10px;
  border: none;
}

footer button {
  padding: 12px 18px;
  background: #23817A;
  border: none;
  border-radius: 10px;
  color: white;
  cursor: pointer;
}

/* ===== ANIM ===== */
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ===== "Spocky r√©fl√©chit..." ===== */
.thinking {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  font-style: italic;
  opacity: 0.9;
}

.dots {
  display: inline-flex;
  gap: 4px;
}

.dots span {
  width: 6px;
  height: 6px;
  background: #111;
  border-radius: 50%;
  display: inline-block;
  animation: bounce 1s infinite ease-in-out;
  opacity: 0.7;
}

.dots span:nth-child(2) { animation-delay: 0.15s; }
.dots span:nth-child(3) { animation-delay: 0.30s; }

@keyframes bounce {
  0%, 80%, 100% { transform: translateY(0); opacity: 0.6; }
  40% { transform: translateY(-5px); opacity: 1; }
}
</style>
</head>

<body>

<!-- AUTH -->
<div id="auth-overlay">
  <div id="auth-box">
    <img src="https://spoc.pro/wp-content/uploads/2025/04/Spocky.png" class="auth-logo">
    <h2>Bienvenue üëã</h2>
    <p>Merci de renseigner vos informations pour acc√©der au support SPOC.</p>
    <input id="firstName" placeholder="Pr√©nom">
    <input id="lastName" placeholder="Nom">
    <input id="email" placeholder="Adresse e-mail">
    <button onclick="login()">Acc√©der au chat</button>
  </div>
</div>

<!-- HEADER -->
<header>
  <div class="header-left">
    <img src="https://spoc.pro/wp-content/uploads/2025/04/Spocky.png">
    <div>
      <div><b>Spocky</b></div>
      <div style="font-size:12px;color:#aaa;">Assistant support SPOC</div>
    </div>
  </div>
  <div>
    <span class="badge-user" id="userBadge"></span>
    <span class="logout" onclick="logout()">D√©connexion</span>
  </div>
</header>

<!-- CHAT -->
<div id="chat"></div>

<!-- INPUT -->
<footer>
  <input id="input" placeholder="√âcris ton message‚Ä¶">
  <button onclick="send()">Envoyer</button>
</footer>

<!-- ‚úÖ Turnstile container (au lieu du div cf-turnstile auto) -->
<div id="turnstile-container"></div>

<script>
const WEBHOOK_URL = "https://spoc-cloud.app.n8n.cloud/webhook/spocky/help";
const SESSION_KEY = "spocky_session";
let mode = null;

/* ‚úÖ Option 2 : 1 message = 1 Turnstile */
let queuedPayload = null;

/* ‚úÖ Turnstile widget id (obligatoire pour reset/execute en invisible) */
let turnstileWidgetId = null;

function initTurnstile() {
  if (turnstileWidgetId) return;

  if (window.turnstile && typeof window.turnstile.render === "function") {
    turnstileWidgetId = window.turnstile.render("#turnstile-container", {
      sitekey: "0x4AAAAAACObC1d7FKkSkeUv",
      size: "invisible",
      callback: onTurnstileSuccess
    });
  } else {
    // Turnstile charg√© async/defer -> on r√©essaye un peu plus tard
    setTimeout(initTurnstile, 150);
  }
}
window.addEventListener("load", initTurnstile);

async function onTurnstileSuccess(token) {
  if (!queuedPayload) return;

  const { msg, sessionId, mode, thinkingId } = queuedPayload;
  queuedPayload = null;

  try {
    await sendToWebhook(msg, sessionId, mode, token, thinkingId);
  } finally {
    // üî• CRITIQUE : reset pour permettre un nouveau token au prochain message
    if (window.turnstile && turnstileWidgetId !== null) {
      window.turnstile.reset(turnstileWidgetId);
    }
  }
}

function getSessionId() {
  let id = localStorage.getItem(SESSION_KEY);
  if (!id) {
    id = crypto.randomUUID();
    localStorage.setItem(SESSION_KEY, id);
  }
  return id;
}

function addMessage(text, who, id = null) {
  const div = document.createElement("div");
  div.className = "message " + who;
  if (id) div.id = id;
  div.innerHTML = text;
  document.getElementById("chat").appendChild(div);
  div.scrollIntoView({ behavior: "smooth" });
  return div;
}

/* Effet "lettre par lettre" (supporte <br>) */
async function typewriterHTML(el, html, speed = 14) {
  const token = "___BR___";
  const safe = html.replaceAll("<br>", token);

  el.innerHTML = "";
  for (let i = 0; i < safe.length; i++) {
    const ch = safe[i];
    if (safe.slice(i, i + token.length) === token) {
      el.innerHTML += "<br>";
      i += token.length - 1;
    } else {
      el.innerHTML += ch;
    }
    await new Promise(r => setTimeout(r, speed));
  }
}

function showThinkingBubble() {
  const id = "thinking-" + Date.now();
  addMessage(
    `<span class="thinking">Spocky r√©fl√©chit
      <span class="dots"><span></span><span></span><span></span></span>
     </span>`,
    "bot",
    id
  );
  return id;
}

function showChoices() {
  addMessage(`
    <b>Que souhaitez-vous faire ?</b><br><br>
    <button class="choice-btn ticket" onclick="selectMode('ticket')">üßæ Cr√©er un ticket</button>
    <button class="choice-btn ai" onclick="selectMode('ai')">ü§ñ Spocky (IA SPOC), aide-moi</button>
  `, "bot");
}

function selectMode(m) {
  mode = m;
  if (m === "ticket") {
    addMessage("üßæ Cr√©ation de ticket s√©lectionn√©e.", "user");
    addMessage("Merci de d√©crire votre demande.", "bot");
  } else {
    addMessage("ü§ñ Mode Spocky activ√©.", "user");
    addMessage("Je suis √† votre √©coute üôÇ", "bot");
  }
}

function login() {
  const f = firstName.value.trim();
  const l = lastName.value.trim();
  const e = email.value.trim();
  if (!f || !l || !e) return alert("Champs manquants");

  localStorage.setItem("spocky_user", JSON.stringify({ f, l, e }));
  document.getElementById("auth-overlay").style.display = "none";
  document.getElementById("userBadge").innerText = `Connect√© : ${f} ${l}`;

  addMessage(
    `Bonjour <b>${f}</b> üëã<br>
     Je suis <b>Spocky</b>, assistant support SPOC.<br>
     Comment puis-je vous aider aujourd‚Äôhui ?`,
    "bot"
  );

  showChoices();
}

function logout() {
  localStorage.removeItem("spocky_user");
  localStorage.removeItem(SESSION_KEY);
  location.reload();
}

async function send() {
  const input = document.getElementById("input");
  const msg = input.value.trim();
  if (!msg) return;

  if (!mode) {
    addMessage("Veuillez d‚Äôabord choisir une option ci-dessus.", "bot");
    return;
  }

  // üîí anti double-clic pendant une requ√™te en vol
  if (queuedPayload) {
    addMessage("‚è≥ Un message est d√©j√† en cours d‚Äôenvoi. Patientez une seconde üôÇ", "bot");
    return;
  }

  addMessage(msg, "user");
  input.value = "";

  const thinkingId = showThinkingBubble();

  queuedPayload = {
    msg,
    sessionId: getSessionId(),
    mode,
    thinkingId
  };

  // ‚ö†Ô∏è Turnstile doit √™tre pr√™t
  if (!window.turnstile || turnstileWidgetId === null) {
    document.getElementById(thinkingId)?.remove();
    addMessage("‚ùå S√©curit√© : Turnstile non pr√™t. R√©essayez dans quelques secondes.", "bot");
    queuedPayload = null;
    return;
  }

  // ‚úÖ Option 2 : on ex√©cute √† CHAQUE message
  window.turnstile.execute(turnstileWidgetId);
}

async function sendToWebhook(msg, sessionId, mode, token, thinkingId) {
  const res = await fetch(WEBHOOK_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      chatInput: msg,
      sessionId: sessionId,
      mode: mode,
      turnstileToken: token
    })
  });

  const data = await res.json();

  if (thinkingId) document.getElementById(thinkingId)?.remove();

  const botEl = addMessage("", "bot");
  const answer = (data && (data.message || data.output)) ? (data.message || data.output) : "R√©ponse vide";
  await typewriterHTML(botEl, String(answer).replaceAll("\n", "<br>"), 12);
}

/* Auto-login */
const user = JSON.parse(localStorage.getItem("spocky_user"));
if (user) {
  document.getElementById("auth-overlay").style.display = "none";
  document.getElementById("userBadge").innerText = `Connect√© : ${user.f} ${user.l}`;
  addMessage(
    `Bonjour <b>${user.f}</b> üëã<br>
     Ravi de vous revoir. Comment puis-je vous aider ?`,
    "bot"
  );
  showChoices();
}


// ===== MODE PAR D√âFAUT (ticket) =====
const MODE_KEY = "spocky_mode";

let savedMode = localStorage.getItem(MODE_KEY);

if (!savedMode) {
  savedMode = "ticket";
  localStorage.setItem(MODE_KEY, savedMode);
}

mode = savedMode;

const inputField = document.getElementById("input");
inputField.addEventListener("keydown", function (event) {
  if (event.key === "Enter" && !event.shiftKey) {
    event.preventDefault();
    send();
  }
});

</script>

</body>
</html>
